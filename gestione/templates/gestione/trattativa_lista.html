{% extends 'gestione/base.html' %}
{% load bootstrap5 %}
{% load static %}
{% load humanize %}

{% block title %}Lista Trattative{% endblock %}

{% block content %}

<div class="container-fluid pt-4 px-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <ul class="nav nav-pills">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'kanban_board' %}"><i class="bi bi-kanban-fill"></i> Kanban</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="{% url 'trattativa_lista' %}"><i class="bi bi-list-ul"></i> Lista</a>
            </li>
        </ul>
        <div>
            <a href="{% url 'esporta_trattative_excel' %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download"></i> Esporta Excel</a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            Tutte le Trattative ({{ trattative|length }})
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover small mb-0">
                <thead>
                    <tr>
                        <th>Titolo</th>
                        <th>Stato</th>
                        <th>Cliente</th>
                        <th>Commerciale</th>
                        <th class="text-end">Valore Stimato (€)</th>
                        <th class="text-end">Costo Materiali (€)</th>
                        <th class="text-end">Costo Personale (€)</th>
                        <th class="text-end">Margine Stimato (€)</th>
                        <th class="text-end">Margine Stimato (%)</th>
                        <th>Creata il</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in trattative %}
                    <tr>
                        <td>
                            <a href="{% url 'trattativa_dettaglio' t.id %}">
                                <strong>{{ t.titolo }}</strong>
                            </a>
                        </td>
                        <td>
                            <span class="badge {% if t.stato == 'VINTO' %}bg-success{% elif t.stato == 'PERSO' %}bg-danger{% else %}bg-secondary{% endif %}">
                                {{ t.get_stato_display|cut:"1. "|cut:"2. "|cut:"3. "|cut:"4. "|cut:"5. "|cut:"6. "|cut:"7. "|cut:"8. " }}
                            </span>
                        </td>
                        <td>{{ t.cliente_nome }}</td>
                        <td>{{ t.commerciale.username|default:"-" }}</td>
                        <td class="text-end">€ {{ t.valore_stimato|floatformat:2|intcomma }}</td>
                        <td class="text-end">€ {{ t.costo_materiali_stimato|floatformat:2|intcomma }}</td>
                        <td class="text-end">€ {{ t.costo_personale_totale|floatformat:2|intcomma }}</td>
                        <td class="text-end"><strong>€ {{ t.margine_stimato_euro|floatformat:2|intcomma }}</strong></td>
                        
                        {% if t.margine_stimato_perc < 20 %}
                            <td class="text-end text-danger fw-bold">{{ t.margine_stimato_perc|floatformat:1 }}%</td>
                        {% elif t.margine_stimato_perc < 40 %}
                            <td class="text-end text-warning fw-bold">{{ t.margine_stimato_perc|floatformat:1 }}%</td>
                        {% else %}
                            <td class="text-end text-success fw-bold">{{ t.margine_stimato_perc|floatformat:1 }}%</td>
                        {% endif %}

                        <td>{{ t.data_creazione|date:"d M Y" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center p-4">Nessuna trattativa trovata.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}